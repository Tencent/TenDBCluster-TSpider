--echo #
--echo # Test for bugfix: Long BLOB data gets garbled on UPDATE
--echo #

--disable_warnings
--disable_query_log
--source ../t/test_init.inc
--disable_result_log
--enable_result_log
--enable_query_log

--let $USE_CHILD_GROUP2_BACKUP= $USE_CHILD_GROUP2
--let $USE_CHILD_GROUP2= 1
--let $USE_GENERAL_LOG_BACKUP= $USE_GENERAL_LOG
--let $USE_GENERAL_LOG= 1

--source ../include/spider_create_database.inc
--let $TABLE_NAME = t1
--let $TABLE_BODY = id int, a int, b blob, primary key(id)
--echo $TABLE_BODY
--let $TABLE_SHARD_KEY = id
--source ../include/spider_create_table_helper.inc

--connection master_1
INSERT INTO t1 VALUES(1, 0, "1234567890");

if ($USE_GENERAL_LOG)
{
    SET @old_log_output = @@global.log_output;
    SET @old_general_log = @@global.general_log;
    SET @old_spider_general_log = @@global.spider_general_log;
    SET GLOBAL log_output = 'TABLE';
    SET GLOBAL general_log = 1;
    SET GLOBAL spider_general_log = 1;
    TRUNCATE TABLE mysql.general_log;
}

SET spider_bulk_update_mode = 2;
SET spider_bulk_update_size = 10;

UPDATE t1 SET b = '±½èzˆY#‡L·´l^áÛ±½èzˆY#‡L·´l^áÛ±½èzˆY#‡L·´l^áÛ±½èzˆY#‡L·´l^áÛ', a = (case WHEN 0 THEN NULL ELSE a END) WHERE id = 1;


if ($USE_GENERAL_LOG)
{
    SELECT argument FROM mysql.general_log WHERE argument LIKE '%t1%';
    TRUNCATE TABLE mysql.general_log;
}

SELECT id, HEX(b) FROM t1;

# cleanup
if ($USE_GENERAL_LOG)
{
    --connection master_1
    SET GLOBAL log_output = @old_log_output;
    SET GLOBAL general_log = @old_general_log;
    SET GLOBAL spider_general_log = @old_spider_general_log;
    TRUNCATE TABLE mysql.general_log;
}

--let @USE_CHILD_GROUP2= $USE_CHILD_GROUP2_BACKUP
--let @USE_GENERAL_LOG= $USE_GENERAL_LOG_BACKUP

--source ../include/spider_drop_database.inc
