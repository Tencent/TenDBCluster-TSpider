--disable_warnings
--disable_query_log
--source ../t/test_init.inc
--enable_result_log
--enable_query_log

--let $USE_CHILD_GROUP2_BACKUP= $USE_CHILD_GROUP2
--let $USE_CHILD_GROUP2= 1

--source ../include/spider_create_database.inc
--let $TABLE_NAME = t1
--let $TABLE_BODY = id INT PRIMARY KEY, a INT, v VARCHAR(64)
--let $TABLE_SHARD_KEY = id
--source ../include/spider_create_table_helper.inc

--let $USE_GENERAL_LOG_BACKUP= $USE_GENERAL_LOG
--let $USE_GENERAL_LOG= 1

if ($USE_GENERAL_LOG)
{
    --connection master_1
    SET @old_log_output = @@global.log_output;
    SET @old_spider_general_log = @@global.spider_general_log;
    SET GLOBAL log_output = 'TABLE';
    SET GLOBAL spider_general_log=1;
    TRUNCATE TABLE mysql.general_log;

    --connection child2_1
    SET @old_log_output = @@global.log_output;
    SET GLOBAL log_output = 'TABLE';
    TRUNCATE TABLE mysql.general_log;

    --connection child2_2
    SET @old_log_output = @@global.log_output;
    SET GLOBAL log_output = 'TABLE';
    TRUNCATE TABLE mysql.general_log;
}

--connection master_1
USE auto_test_local;
INSERT INTO t1 VALUES
(1, 1, 'Shenzhen'),
(2, 1, 'Guangzhou'),
(3, 2, 'Nanjing'),
(4, 2, 'Suzhou'),
(5, 3, 'Beijing'),
(6, 4, 'Shanghai');

SET @@spider_parallel_limit = OFF;

SELECT COUNT(DISTINCT a) FROM t1 LIMIT 1;
SELECT COUNT(DISTINCT v) FROM t1 LIMIT 1;

if ($USE_GENERAL_LOG)
{
    SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
    TRUNCATE TABLE mysql.general_log;
    if ($USE_CHILD_GROUP2)
    {
        --connection child2_1
        SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
        TRUNCATE TABLE mysql.general_log;
        --connection child2_2
        SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
        TRUNCATE TABLE mysql.general_log;
    }
}

--connection master_1
SET @@spider_parallel_limit = ON;

SELECT COUNT(DISTINCT a) FROM t1 LIMIT 1;
SELECT COUNT(DISTINCT v) FROM t1 LIMIT 1;

if ($USE_GENERAL_LOG)
{
    SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
    TRUNCATE TABLE mysql.general_log;
    if ($USE_CHILD_GROUP2)
    {
        --connection child2_1
        SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
        TRUNCATE TABLE mysql.general_log;
        --connection child2_2
        SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
        TRUNCATE TABLE mysql.general_log;
    }
}

--echo #
--echo # Issue #73: SELECT DISTINCT LIMIT gets wrong results
--echo #

--connection master_1
--let $TABLE_NAME = t1
--let $TABLE_BODY = id INT PRIMARY KEY, c1 INT, status INT
--let $TABLE_SHARD_KEY = id
--source ../include/spider_create_table_helper.inc

--connection master_1
INSERT INTO `t1` VALUES
(75, 2, 401),
(149, 3, 401),
(334, 4, 401),
(445, 5, 402),
(556, 6, 402),
(630, 7, 402),
(667, 8, 402),
(741, 9, 403),
(852, 10, 403),
(963, 11, 403),
(1148, 12, 403),
(1259, 13, 403),
(1407, 14, 403),
(1444, 15, 404),
(1, 16, 401),
(38, 17, 401),
(112, 18, 401),
(186, 19, 401),
(223, 20, 401),
(260, 21, 401),
(297, 22, 401),
(371, 23, 401),
(408, 24, 401),
(482, 25, 402),
(519, 26, 402),
(593, 27, 402),
(704, 28, 403),
(778, 29, 403),
(815, 30, 403),
(889, 31, 403),
(926, 32, 403),
(1000, 33, 403),
(1037, 34, 403),
(1074, 35, 403),
(1111, 36, 403),
(1185, 37, 403),
(1222, 38, 403),
(1296, 39, 403),
(1333, 40, 403),
(1370, 41, 403),
(1481, 42, 404),
(1518, 43, 404);

SET @@spider_parallel_limit = OFF;

SELECT DISTINCT status FROM t1 WHERE c1 != 0 LIMIT 10;
if ($USE_GENERAL_LOG)
{
    SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
    TRUNCATE TABLE mysql.general_log;
    if ($USE_CHILD_GROUP2)
    {
        --connection child2_1
        SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
        TRUNCATE TABLE mysql.general_log;
        --connection child2_2
        SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
        TRUNCATE TABLE mysql.general_log;
    }
}

--connection master_1
SET @@spider_parallel_limit = ON;

SELECT DISTINCT status FROM t1 WHERE c1 != 0 LIMIT 10;
if ($USE_GENERAL_LOG)
{
    SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
    TRUNCATE TABLE mysql.general_log;
    if ($USE_CHILD_GROUP2)
    {
        --connection child2_1
        SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
        TRUNCATE TABLE mysql.general_log;
        --connection child2_2
        SELECT argument FROM mysql.general_log WHERE argument LIKE '%select %' AND argument NOT LIKE '%argument%';
        TRUNCATE TABLE mysql.general_log;
    }
}

# cleanup
--connection master_1
if ($USE_GENERAL_LOG)
{
    --connection master_1
    SET GLOBAL log_output = @old_log_output;
    SET GLOBAL spider_general_log = @old_spider_general_log;
    TRUNCATE TABLE mysql.general_log;

    --connection child2_1
    SET GLOBAL log_output = @old_log_output;
    TRUNCATE TABLE mysql.general_log;

    --connection child2_2
    SET GLOBAL log_output = @old_log_output;
    TRUNCATE TABLE mysql.general_log;
}

--let @USE_CHILD_GROUP2= $USE_CHILD_GROUP2_BACKUP
--let @USE_GENERAL_LOG= $USE_GENERAL_LOG_BACKUP

--source ../include/spider_drop_database.inc
