--echo #
--echo # TenDBCluster3 Issue #64: [bug] ALTER TABLE CONVERT CHARACTER SET always fails for Spide tables.
--echo #

--disable_warnings
--disable_query_log
--source ../t/test_init.inc
--disable_result_log
--enable_result_log
--enable_query_log

--connection master_1
--disable_warnings
DROP DATABASE IF EXISTS auto_test_local;
CREATE DATABASE auto_test_local;
USE auto_test_local;
--enable_warnings

--disable_warnings
DROP TABLE IF EXISTS tbl_a;
--enable_warnings
--disable_query_log
--echo
--echo # Creating a Spider table having a column charset different with the table charset is not allowed
echo CREATE TABLE tbl_a (
  col_a INT NOT NULL AUTO_INCREMENT,
  col_b VARCHAR(20) CHARACTER SET latin1 DEFAULT 'defg',
  col_c INT NOT NULL DEFAULT 100,
  PRIMARY KEY(col_a)
) DEFAULT CHARACTER SET=utf8 MASTER_1_ENGINE MASTER_1_COMMENT_2_1;
--error ER_COLUMN_CAN_NOT_CHARSET_IN_CURRENT_STORAGE
eval CREATE TABLE tbl_a (
  col_a INT NOT NULL AUTO_INCREMENT,
  col_b VARCHAR(20)  CHARACTER SET latin1 DEFAULT 'defg',
  col_c INT NOT NULL DEFAULT 100,
  PRIMARY KEY(col_a)
) DEFAULT CHARACTER SET=utf8 $MASTER_1_ENGINE $MASTER_1_COMMENT_2_1;
--enable_query_log

--disable_warnings
DROP TABLE IF EXISTS tbl_a;
--enable_warnings
--disable_query_log
--echo
--echo # Convert a Spider table's charset by ALTER TABLE
echo CREATE TABLE tbl_a (
  col_a INT NOT NULL AUTO_INCREMENT,
  col_b VARCHAR(20) DEFAULT 'defg',
  col_c INT NOT NULL DEFAULT 100,
  PRIMARY KEY(col_a)
) DEFAULT CHARACTER SET=utf8 MASTER_1_ENGINE MASTER_1_COMMENT_2_1;
eval CREATE TABLE tbl_a (
  col_a INT NOT NULL AUTO_INCREMENT,
  col_b VARCHAR(20) DEFAULT 'defg',
  col_c INT NOT NULL DEFAULT 100,
  PRIMARY KEY(col_a)
) DEFAULT CHARACTER SET=utf8 $MASTER_1_ENGINE $MASTER_1_COMMENT_2_1;
--enable_query_log

--echo
--echo # Should return no errors
ALTER TABLE tbl_a CONVERT TO CHARACTER SET utf8mb4;

--source ../include/spider_drop_database.inc
