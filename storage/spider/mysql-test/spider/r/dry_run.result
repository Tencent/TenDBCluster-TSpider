#
# Test for SPIDER DRY RUN
#
for master_1
for child2
child2_1
child2_2
child2_3
for child3
child3_1
child3_2
child3_3

drop and create databases
connection master_1;
DROP DATABASE IF EXISTS auto_test_local;
CREATE DATABASE auto_test_local;
USE auto_test_local;
connection child2_1;
DROP DATABASE IF EXISTS auto_test_remote;
CREATE DATABASE auto_test_remote;
USE auto_test_remote;
connection child2_2;
DROP DATABASE IF EXISTS auto_test_remote_2;
CREATE DATABASE auto_test_remote_2;
USE auto_test_remote_2;

create table for child
connection child2_1;
CHILD2_1_DROP_TABLES
CHILD2_1_CREATE_TABLES
connection child2_2;
CHILD2_2_DROP_TABLES
CHILD2_2_CREATE_TABLES

create table for master
connection master_1;
DROP TABLE IF EXISTS t1;;
CREATE TABLE t1 (id INT PRIMARY KEY, c1 int, c2 int, KEY (c1))ENGINE=Spider DEFAULT CHARSET=utf8 PARTITION BY LIST (CRC32(id) % 2)( PARTITION `pt0` VALUES IN (0) COMMENT = 'database "auto_test_remote", table "t1", srv "s_2_1",aim "0"', PARTITION `pt1` VALUES IN (1) COMMENT = 'database "auto_test_remote_2", table "t1", srv "s_2_2",aim "1"');;
SET @spider_bgs_mode_backup = @@spider_bgs_mode;
SET @spider_quick_mode_backup = @@spider_quick_mode;
INSERT INTO t1 VALUES
(1,1,1), (3,3,3);
SELECT * FROM t1;
id	c1	c2
1	1	1
3	3	3
SELECT SPIDER_DRY_RUN * FROM t1;
id	c1	c2
SELECT id, c1, c2 FROM t1;
id	c1	c2
1	1	1
3	3	3
SELECT SPIDER_DRY_RUN id, c1, c2 FROM t1;
id	c1	c2
SELECT MAX(c1), MAX(c2) FROM t1 WHERE id > 10;
MAX(c1)	MAX(c2)
NULL	NULL
SELECT SPIDER_DRY_RUN MAX(c1), MAX(c2) FROM t1 WHERE id > 10;
MAX(c1)	MAX(c2)
NULL	NULL
SELECT id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)
1	1
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)

# Try different combinations of <spider_bgs_mode> and <spider_quick_mode> to make sure dry-run does not cause strange crashes

SET spider_bgs_mode = 1;
SET spider_quick_mode = 0;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)
SET spider_quick_mode = 1;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)
SET spider_quick_mode = 2;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)
SET spider_quick_mode = 3;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)
SET spider_bgs_mode = 0;
SET spider_quick_mode = 0;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)
SET spider_quick_mode = 1;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)
SET spider_quick_mode = 2;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)
SET spider_quick_mode = 3;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
id	max(c2)

# Using dry-run in a transaction should cause Error

BEGIN;
SELECT SPIDER_DRY_RUN id, max(c2) FROM t1 WHERE c1 < 2 GROUP BY id LIMIT 10;
ERROR HY000: Got error 12731 'Spider dry-run cannot be done in a transaction, use autocommit mode instead' from SPIDER
ROLLBACK;
SET spider_bgs_mode = @spider_bgs_mode_backup;
SET spider_quick_mode = @spider_quick_mode_backup;

deinit
connection master_1;
DROP DATABASE IF EXISTS auto_test_local;
connection child2_1;
DROP DATABASE IF EXISTS auto_test_remote;
connection child2_2;
DROP DATABASE IF EXISTS auto_test_remote_2;
for master_1
for child2
child2_1
child2_2
child2_3
for child3
child3_1
child3_2
child3_3

end of test
